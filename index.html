<!DOCTYPE html>
<html lang="uk">

<head>
  <meta charset="UTF-8">
  <title>KoncertLibe info – Мапа Wrocław</title>

  <!-- Мобільна адаптація -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100vh;
    }

    /* Обмежуємо ширину попапів на маленьких екранах */
    .leaflet-popup-content-wrapper {
      max-width: 200px;
    }

    /* Адаптивні стилі для смартфонів */
    @media (max-width: 600px) {
      .leaflet-popup-content {
        font-size: 14px;
      }
    }

    /* Стилі легенди */
    .legend {
      background: white;
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      line-height: 24px;
      font-size: 14px;
    }

    .legend i {
      width: 24px;
      height: 24px;
      display: inline-block;
      margin-right: 5px;
      vertical-align: middle;
      background-size: 20px 20px;
      background-repeat: no-repeat;
      background-position: center;
    }
  </style>
</head>

<body>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /* =========================
       1. ІНІЦІАЛІЗАЦІЯ МАПИ
    ========================= */
    const map = L.map('map', {
      tap: true,
      touchZoom: true,
      zoomControl: true
    }).setView([51.1079, 17.0385], 13);

    /* =========================
       2. БАЗОВІ ШАРИ
    ========================= */
    const baseMaps = {
      "Світла": L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        { attribution: '© OpenStreetMap © CartoDB' }
      ),
      "Темна": L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        { attribution: '© OpenStreetMap © CartoDB' }
      ),
      "OSM": L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '© OpenStreetMap' }
      )
    };

    baseMaps["Світла"].addTo(map);

    /* =========================
       3. ІКОНКИ
    ========================= */
    const iconSize = window.innerWidth < 600 ? [24, 24] : [32, 32];
    const iconAnchor = [iconSize[0] / 2, iconSize[1]];
    const popupAnchor = [0, -iconSize[1]];

    const icons = {
      flyers: L.icon({ iconUrl: 'icons/flyer.png', iconSize, iconAnchor, popupAnchor }),
      posters: L.icon({ iconUrl: 'icons/poster.png', iconSize, iconAnchor, popupAnchor }),
      shops: L.icon({ iconUrl: 'icons/shop.png', iconSize, iconAnchor, popupAnchor })
    };

    /* =========================
       4. ШАРИ
    ========================= */
    const layers = {
      flyers: L.layerGroup(),
      posters: L.layerGroup(),
      shops: L.layerGroup()
    };

    /* =========================
       5. ДАНІ (Google Sheet CSV)
    ========================= */
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSe5LSFMqfWCAF516DuZF3Vm5Q5JCunY4CwCqEuyOkfQG2PXMlAGz93FmPxiQbsfYorpCqdqfyGgXAN/pub?output=csv';

    async function loadPlaces() {
      const res = await fetch(sheetUrl);
      const csv = await res.text();

      const rows = csv.split('\n').slice(1);
      rows.forEach(row => {
        const [type, lat, lng, title, address, hours] = row.split(',');
        if (type && lat && lng) {
          L.marker([parseFloat(lat), parseFloat(lng)], { icon: icons[type] })
            .bindPopup(`<strong>${title}</strong><br>Адреса: ${address}<br>Графік: ${hours}`)
            .addTo(layers[type]);
        }
      });
    }

    loadPlaces();

    /* =========================
       6. ДОДАЄМО ШАРИ НА МАПУ
    ========================= */
    layers.flyers.addTo(map);
    layers.posters.addTo(map);
    layers.shops.addTo(map);

    /* =========================
       7. КОНТРОЛЬ ШАРІВ
    ========================= */
    L.control.layers(baseMaps, {
      "Флаєри": layers.flyers,
      "Афіші": layers.posters,
      "Магазини": layers.shops
    }).addTo(map);

    /* =========================
       8. ЛЕГЕНДА
    ========================= */
    const legend = L.control({ position: 'bottomright' });

    legend.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>Легенда</h4>
        <i style="background-image: url('icons/flyer.png');"></i> Флаєри<br>
        <i style="background-image: url('icons/poster.png');"></i> Афіші<br>
        <i style="background-image: url('icons/shop.png');"></i> Магазини
      `;
      return div;
    };

    legend.addTo(map);
  </script>

</body>

</html>